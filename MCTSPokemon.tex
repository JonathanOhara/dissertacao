\chapter{MCTS para o jogo Pokémon}
\label{chap:mctsPokemon}

\section{Introdução}

Nos capítulos anteriores sobre árvore de jogos e aprendizagem de jogos com humanos. Nesse capítulo o foco será a implementação de um agente para o jogo Pokémon Showdown!. O interesse em fazer agente para esse jogo são quatro fatores. Alto nível de competitividade, dezenas de milhares de pessoas jogam diariamente o jogo, além da existência de diversos campeonatos. Jogo de informações imperfeitas com grande nível de ramificação de escolhas. Jogo totalmente \textit{online}, podendo explorar o aprendizado com jogadores humanos num ambiente difícil de identificar se o adversário é um \textit{bot} ou não. Possibilidade de criar uma API para possibilitar outros pesquisadores criar agentes e a possibilidade de se criar uma competição entre agentes jogadores.

O capítulo está organizado da seguinte forma: a primeira seção \ref{sec:pokemon} é apresentada a franquia de jogos Pokémon. Na próxima seção \ref{sec:batalhaspokemon} é apresentado as mecânicas e as regras das batalhas Pokémon. Na seção \ref{sec:pokemonshowdown} será apresentado a plataforma Pokémon Showdown!, como ela funciona e suas regras competitivas especiais. Na seção \ref{sec:apipokemonshowdown} será apresentado a API para se comunicar com o jogo Pokémonm Showdown!. Em \ref{sec:mctsPokemonShowdown} é mostrado alguns a implementação de agentes utilizando MCTS para o Pokémon Showdown!.

\section{Pokémon}
\label{sec:pokemon}

\textit{Pocket Monsters} ou Pokémon é uma série de jogos desenvolvida pela \textit{Game Freak and Creatures Inc.} e publicada pela Nintendo como parte da franquia Pokémon. O primeiro lançamento foi em 1996 no Japão para o console Game Boy Color, a principal série do jogo é baseada em \textit{Role-Playing-Game} (RPG) e continua a ser lançado para consoles portáteis até hoje (\cite{7336034}).

Ainda segundo \cite{7336034} o objetivo dos jogos de RPG de Pokémon é capturar monstros chamados de Pokémon e com eles conseguir ganhar insígnias de ginásios (prêmio dado por vencer o líder de ginásio em uma batalha Pokémon), para assim ter acesso a liga Pokémon e se tornar o campeão dessa (torneio com os melhores treinadores Pokémon do jogo).

Em 2016 a franquia completou 20 anos desde o lançamento de seu primeiro jogo. Os últimos jogos da franquia principal foram lançados no final de 2016 chamados de Pokémon Sun e Pokémon Moon.

\subsection{Características de um Pokémon}

Nos jogos, um Pokémon é um monstro virtual semelhante a um animal ou objeto com superpoderes. A característica final do Pokémon é baseada na característica de sua espécie e de suas características únicas. Essa combinação possibilita ter um grande nível de customização em cada Pokémon.

\subsubsection{Espécie}

A espécie é qual modelo aquele Pokémon representa. Existem atualmente mais de 800 espécies de Pokémon. Algumas espécies podem evoluir para outra espécie quando o Pokémon atinge certos critérios. A figura \ref{fig:pokemonespecie} de \cite{pokedex} mostra quatro diferentes espécies Pokémon e suas principais características. Detalhadamente cada espécie Pokémon tem as seguintes características:

\begin{itemize}
	
	\item \textbf{Número}. Identificação numérica única.
	
	\item \textbf{Nome}. Nome do Pokémon.
	
	\item \textbf{Tipo}. Cada Pokémon ter um ou dois tipos associados a sua espécie.
	
	\item \textbf{Estatística base}. As estatística ou atributos base são separado em 6 categorias:
		\subitem \textbf{HP ou PS}. Quantidade de pontos de vida Pokémon;
		\subitem \textbf{Attack ou Ataque}. Quantidade de ataque físico do Pokémon;
		\subitem \textbf{Defense ou Defesa}. Quantidade de defesa física do Pokémon;
		\subitem \textbf{Special Attack ou Ataque Especial}. Quantidade de ataque mágico do Pokémon;
		\subitem \textbf{Special Defense ou Defesa Especial}. Quantidade de defesa mágica do Pokémon;
		\subitem \textbf{Speed ou Velocidade}. Quantidade de Velocidade do Pokémon;
	
	\item \textbf{Gama de habilidades}. Uma espécie de Pokémon tem três habilidades, sendo que o Pokémon daquela espécie terá apenas uma delas.
	
	\item \textbf{Gama de movimentos}. Uma espécie de Pokémon pode aprender dezenas de golpes diferentes (baseado no tipo e nas características do Pokémon), sendo que o Pokémon daquela espécie terá apenas quatro delas.
	
	\item \textbf{Altura base}. Altura base da espécie.
	
	\item \textbf{Peso base}. Peso base da espécie.
	
	\item \textbf{Sexo}. Algumas espécies podem ter apenas um sexo, ou seja, ser apenas macho ou fêmea.
	
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=\columnwidth]{figures/pokemonespecie.png}
\caption[Espécies Pokémon]{Espécies Pokémon (\cite{pokedex}).}
\label{fig:pokemonespecie}
\end{figure}

A figura \ref{fig:pokemonmewto} de \cite{pokedex} mostra um exemplo de uma espécie Pokémon e suas características.

\begin{figure}[H]
\centering
\includegraphics[width=10cm]{figures/pokemonmewto.png}
\caption[Detalhes Pokémon]{Detalhes Pokémon Mewtwo (\cite{pokedex}).}
\label{fig:pokemonmewto}
\end{figure}

Existem 18 tipos de Pokémon entre eles: planta, fogo, água, inseto, normal, venenoso, elétrico, terra, lutador, psíquico, pedra, voador, fantasma, gelo, dragão, metálico, noturno e fada.

Alguns tipos de Pokémon tem vantagem sobre outros tipos de Pokémon. A ideia é baseada no sistema papel pedra tesoura, onde o papel ganha de pedra, pedra ganha de tesoura e por sua vez tesoura ganha de papel. Porém no sistema de batalhas Pokémon essa mecânica é um pouco mais complexa, uma vez que podem existir até 2 tipos para cada Pokémon.

\subsubsection{Características únicas}

Cada Pokémon tem uma série de características únicas, são elas:

\begin{itemize}
	
	\item \textbf{Level}. Nível do Pokémon. Onde $0 \leq level \leq 100$.
	
	\item \textbf{Effort Values ou EV}. Valores de esforço, cada Pokémon tem 510 pontos de EV que podem ser distribuídos em qualquer um dos 6 atributos, com a limitação de que cada atributo pode ter no máximo 252 pontos de EV.
	
	\item \textbf{Individual Values ou IV}. Valores individuais, cada atributo do Pokémon tem um valor de IV associado que varia entre 0 e 31.
	
	\item \textbf{Nature}. Natureza do Pokémon. Existem 25 diferentes naturezas que um Pokémon pode ter, sendo que 21 delas alteram atributos. As naturezas que alteram atributos adicionam 10\% em um determinado atributo e reduzem 10\% em outro atributo. A tabela \ref{table:tabelaNatureza} mostra as possíveis naturezas e as modificações dos atributos.
	
\end{itemize}
	
\begin{table}[]
\centering
\caption{Possíveis naturezas de um Pokémon}
\label{table:tabelaNatureza}
\begin{tabular}{|c|c|c|}
\hline
\textbf{Natureza} & \textbf{Atributo aumentado} & \textbf{Atributo diminuído} \\ \hline
Lonely            & Ataque                      & Defesa                      \\ \hline
Brave             & Ataque                      & Velocidade                  \\ \hline
Adamant           & Ataque                      & Ataque Especial             \\ \hline
Naughty           & Ataque                      & Defesa Especial             \\ \hline
Bold              & Defesa                      & Ataque                      \\ \hline
Relaxed           & Defesa                      & Velocidade                  \\ \hline
Impish            & Defesa                      & Ataque Especial             \\ \hline
Lax               & Defesa                      & Defesa Especial             \\ \hline
Modest            & Ataque Especial             & Ataque                      \\ \hline
Mild              & Ataque Especial             & Defesa                      \\ \hline
Quiet             & Ataque Especial             & Velocidade                  \\ \hline
Rash              & Ataque Especial             & Defesa Especial             \\ \hline
Calm              & Defesa Especial             & Ataque                      \\ \hline
Gentle            & Defesa Especial             & Defesa                      \\ \hline
Sassy             & Defesa Especial             & Velocidade                  \\ \hline
Careful           & Defesa Especial             & Ataque Especial             \\ \hline
Timid             & Velocidade                  & Ataque                      \\ \hline
Hasty             & Velocidade                  & Defesa                      \\ \hline
Jolly             & Velocidade                  & Ataque Especial             \\ \hline
Naive             & Velocidade                  & Defesa Especial             \\ \hline
Hardy             & Nenhum                      & Nenhum                      \\ \hline
Docile            & Nenhum                      & Nenhum                      \\ \hline
Serious           & Nenhum                      & Nenhum                      \\ \hline
Bashful           & Nenhum                      & Nenhum                      \\ \hline
Quirky            & Nenhum                      & Nenhum                      \\ \hline
\end{tabular}
\end{table}

\subsubsection{Características calculadas}

O valor final dos atributos é calculado de duas formas diferentes. O valor final de HP é dado pela seguinte equação:

\begin{equation}
V = \Bigg( \frac{ \Big( ( 2 \times Base + IV + \frac{EV}{4} ) \times level \Big) }{100} + level + 10 \Bigg),
\end{equation}

já o resto dos atributos é dado pela seguinte equação:

\begin{equation}
V = \Bigg( \frac{ \Big( ( 2 \times Base + IV + \frac{EV}{4} ) \times level \Big) }{100} + 5 \Bigg) \times Nature,
\end{equation}

onde \textbf{V} É o valor final, valor que o jogador irá ver no jogo. \textbf{Base} É a quantidade básica da estatística definido pela espécie. \textbf{Nature} Se a natureza do Pokémon favorecer esse atributo o valor é atribuído 1.1, caso a natureza desfavoreça esse valor é 0.9 e caso a natureza não influa nesse atributo o valor é 1.

Para exemplificar esse cálculo de atributos mostrar como é importante a customização dentro do jogo do Pokémon, a seguir será calculado o atributo "Especial Ataque"  para 2 Pokémon da espécie Mewtwo ambos no nível 100. O Pokémon Mewtwo tem 154 pontos de Ataque Especial base.

O primeiro Mewtwo será chamado de Mewtwo A. O Mewtwo A é da natureza Modest e tem 252 pontos de EV em Ataque Especial e 31 pontos de IV no atributo Ataque Especial. Substituindo essas variáveis na equação:

\begin{equation}
447.7 = \Bigg( \frac{ \Big( ( 2 \times 154 + 31 + \frac{252}{4} ) \times 100 \Big) }{100} + 5 \Bigg) \times 1.1
\end{equation}

O segundo Mewtwo será chamado de Mewtwo B. O Mewtwo B é da natureza Adamant e tem 0 pontos de EV em Ataque Especial e 0 pontos de IV no atributo Ataque Especial. Substituindo essas variáveis na equação:

\begin{equation}
281.7 = \Bigg( \frac{ \Big( ( 2 \times 154 + 0 + \frac{0}{4} ) \times 100 \Big) }{100} + 5 \Bigg) \times 0.9
\end{equation}

A diferença do atributo Especial Ataque do Mewtwo A e do Mewtwo B é de 166 pontos, ou seja, o Mewtwo A tem cerca de 66\% mais pontos nesse atributo que o Mewtwo B. 

Cada também Pokémon pode carregar consigo um item, esse item também traz certos tipos de benefícios para o Pokémon. Alguns itens são ativados quando uma condição ocorre na batalha, outros itens são contínuos. Existem cerca de 300 itens diferentes. Um exemplo de item é o \textit{Leftovers} que recupera $\frac{1}{16}$ do HP total do Pokémon ao final de cada turno.

\section{Batalhas Pokémon}
\label{sec:batalhaspokemon}

Existem diversos tipos de batalhas dentro do jogo Pokémon. Nessa seção é apresentado o modo padrão de batalha chamado \textit{Single Battle}. Existem outros modos apresentados no jogo como:  \textit{Double Batles}, \textit{Tripple Battles} e \textit{Rotation Battle}.

\subsection{Modo Single Battle}

As batalhas acontecem em maioria dos momentos do jogo, onde um treinador desafia outro treinador, podendo o vencedor levar um pouco de dinheiro virtual ou uma medalha (também chamada de insígnia).

Cada treinador pode utilizar até 6 Pokémon sem quaisquer restrições. Vence o treinador que desmaiar todos os Pokémon do adversário primeiro, ou seja, quando todos os Pokémon de um treinador estiverem com o HP igual a zero.

A batalha é realizada por turnos simultâneos. Ao começar a batalha ambos os jogadores colocam um Pokémon no campo de batalha, chamado de Pokémon ativo. Para ambos os jogadores é mostrado as opções de golpes e as opções para trocar de Pokémon.

A decisão de quem irá a executar a ação primeira ocorre de maneira complexa. Simplificando a ordem de qual ação acontece primeiro é dado pelo seguinte (números menores mais prioridade):

\begin{itemize}
	
	\item \textbf{1}. Ação de trocar de Pokémon.
	
	\item \textbf{2}. Golpes de prioridade positiva. Existe um pequeno conjunto de golpes que faz o Pokémon atacar primeiro independente do critério 3. Se ambos o Pokémon utilizarem golpes de prioridade o critério 3 decidirá quem realiza a ação primeiro.
	
	\item \textbf{3}. O Pokémon com maior atributo de velocidade ataca primeiro.
	
	\item \textbf{4}. Golpes de prioridade negativa. Existe também um pequeno conjunto de golpes que faz o Pokémon atacar por último independente do critério 3. Se ambos o Pokémon utilizarem golpes de prioridade negativa o critério 3 decidirá quem realiza a ação primeiro.
	
\end{itemize}

\subsection{Golpes do Pokémon}

Uma das customizações mais importantes são quais golpes o Pokémon irá poder utilizar. Cada Pokémon pode escolher 4 golpes entre dezenas de golpes disponíveis para sua espécie. Cada espécie de Pokémon pode aprender um conjunto diferente de habilidades dependendo do seu tipo e características (por exemplo, apenas Pokémon com chifre conseguem aprender o golpe \textit{Mega Horn}). Existem mais de 600 golpes diferentes.

As principais características dos golpes são:

\begin{itemize}

	\item \textbf{Category ou Categoria}. Existem três tipos de categorias:
		
		\subitem \textbf{Status ou Condição}. Golpes que não infringem dano diretamente, porém tem algum efeito com grande chance de sucesso para compensar.
		
		\subitem \textbf{Physical ou Físico}. Golpes físicos utilizam o Ataque para cálculo de dano e Defesa para cálculo da resistência.
		
		\subitem \textbf{Special ou Especial}. Golpes especiais utilizam o Ataque Especial para cálculo de dano e Defesa Especial para cálculo da resistência.

	\item \textbf{Base Power ou Força base}. A força base ou dano base do golpe. Golpes de condição não tem força base
	
	\item \textbf{Tipo}. Se o tipo do golpe (cada golpe tem apenas um tipo) for um dos tipos do Pokémon que está usando o golpe a base de força é aumentada em 50\% (chamado de STAB ou \textit{Same Type Attack Bonus}).
	
	\item \textbf{Accuracy ou Precisão}. A chance em percentagem de um golpe acertar.
	
	\item \textbf{PP ou Pontos de Poder}. A quantidade de vezes que um Pokémon pode usar um 
	golpe durante uma batalha.
	
	\item \textbf{Efeito Secundário}. Um golpe pode ter um efeito secundário, esse efeito tem uma chance de acontecer e pode afetar uma série de coisas como, por exemplo, deixar o oponente paralisado ou aumentar melhorar algum atributo.
\end{itemize}

É no calculo de dano do golpe que o sistema de papel, pedra e tesoura é aplicado. Existem 6 Situações que podem acontecer quando o golpe é utilizado em um Pokémon:

\begin{itemize}

	\item \textbf{Imune}. O Pokémon adversário é imune ao golpe.

	\item \textbf{Não muito efetivo}. Quando um golpe \textbf{A} é aplicado a um Pokémon do tipo \textbf{B} e \textbf{C}, e tanto \textbf{B} quanto \textbf{C} tem vantagem sobre \textbf{A}. Modificador de dano: 0.25.
	
	\item \textbf{Não efetivo}. Quando um golpe \textbf{A} é aplicado a um Pokémon do tipo \textbf{B} e \textbf{C}, e \textbf{B} ou \textbf{C} tem vantagem sobre \textbf{A}. Modificador de dano: 0.5.
	
	\item \textbf{Normal}. O golpe não tem vantagem ou desvantagem sobre o Pokémon atingido. Modificador de dano: 1.
	
	\item \textbf{Efetivo}. Quando um golpe \textbf{A} é aplicado a um Pokémon do tipo \textbf{B} e \textbf{C}, e \textbf{A} tem vantagem sobre \textbf{B} ou \textbf{C}. Modificador de dano: 2.
	
	\item \textbf{Muito efetivo}. Quando um golpe \textbf{A} é aplicado a um Pokémon do tipo \textbf{B} e \textbf{C}, e \textbf{A} tem vantagem sobre \textbf{B} e \textbf{C}. Modificador de dano: 4.
\end{itemize}

A imagem a seguir foi retirada do site \cite{bulbapedia1} e contém uma tabela mostrando o modificador de dano para cada tipo de golpe em relação ao tipo do adversário. Ao escolher um golpe, o tipo (golpes tem apenas um único tipo) desse golpe é confrontado nessa tabela de acordo com o tipo do adversário, caso o adversário tenha dois tipos a consulta nessa tabela é feita duas vezes e os modificadores são multiplicados gerando um modificar final.

\begin{figure}[!h]
\centering
\includegraphics[width=16cm]{figures/pokemontypechart.png}
\caption[Tabela de vantagens e desvantagens do Pokémon]{Tabela de vantagens e desvantagens do Pokémon. \cite{bulbapedia1}}
\label{fig:pokemontypechart}
\end{figure}

A equação de modificadores de dano é dado por: 

\begin{equation}
Modifier = STAB \times Type \times Critical \times other \times (random[0.85, 1]),
\end{equation}

onde \textbf{Type} É o modificador baseado na vantagem, explicado na subseção anterior, os valores podem variar entre  0, 0.25, 0.5, 1, 2, e 4. \textbf{Critical} Normalmente um golpe tem chance de crítico de 6.25\% caso esse acerto crítico ocorra o valor para Critical é de 1.5, caso contrário o valor é 1. \textbf{Other} São outros modificadores que podem ser adicionados por causa de itens ou estados especiais que modifiquem o dano. \textbf{random} Por final é adicionado um valor aleatório entre 85\% e 100\%.

Para calcular a quantidade de HP que um Pokémon irá perder após sofrer um golpe é denotado pela seguinte equação:

\begin{equation}
Dano = \Bigg( \frac{ 2 \times Level + 10 }{ 250 } \times \frac{Attack}{Defense} \times Base + 2 \Bigg) \times Modifier,
\end{equation}

onde \textbf{Dano}. Quantidade de dano total que o Pokémon irá receber. \textbf{Attack}. É quantidade de Ataque caso o golpe seja da categoria físico, ou quantidade Ataque Especial caso o golpe seja da categoria especial. \textbf{Defense}. É quantidade de Defesa caso o golpe seja da categoria físico, ou quantidade Defesa Especial caso o golpe seja da categoria especial. \textbf{Base}. Base de força definido no golpe.

\subsubsection{Estados especiais de batalha}
\label{sssec:estadosEspeciais}

Existem diferentes estados especiais de batalha que um Pokémon está sujeito, dentro desses estados existem três tipo: primários, secundários e voláteis. Cada Pokémon só pode ser afetado por apenas 1 estado primário de batalha ao mesmo tempo, caso tente ser aplicado mais um estado primário de batalha em um Pokémon que já está sofrendo um estado primário de batalha esse novo estado falhará. 

Os estados especiais primários de batalhas são: 

\begin{itemize}
	\item \textbf{BRN} Estado queimado, nesse estado o Ataque do Pokémon é reduzido em 50\% e, ao final de cada turno o Pokémon recebe 12,5\% da vida máxima como dano.
	\item \textbf{FRZ} Estado congelado, nesse estado o Pokémon não pode utilizar nenhum golpe, a cada turno o Pokémon tem uma chance de 20\% de se descongelar.
	\item \textbf{PAR} Estado paralisado, nesse estado o Pokémon tem 25\% de chance de errar seu golpe e, sua velocidade é reduzida para 25\% do valor.
	\item \textbf{PSN} Estado envenenado, nesse estado o Pokémon perde $\frac{1}{16}$ de seu HP no final do turno, aumentando em $\frac{1}{16}$ para cada turno que ele continuar envenenado.
	\item \textbf{SLP} Estado dormindo, nesse estado o Pokémon não pode atacar. Esse efeito tem duração de 1 até 3 turnos.
\end{itemize}

Existem outras categorias de efeitos que são chamados de efeitos secundários ou efeitos voláteis. Diferentemente dos estados primários, um Pokémon pode ter N desses efeitos aplicados. Existe uma grande lista de efeitos secundários. Um efeito secundário bastante conhecido é a confusão, onde o Pokémon fica confuso de 1 a 4 turnos, caso o Pokémon esteja confuso ele tem 50\% de chance de bater em si próprio ao invés de usar o golpe no adversário.

\section{Pokémon Showdown!}
\label{sec:pokemonshowdown}

Pokémon Showdown é um simulador de batalhas Pokémon. Permitindo jogar batalhas \textit{online} com times gerados aleatoriamente, times predefinidos, ou construindo seu próprio time (\cite{pokemonshowdown1}).

Esse ambiente é totalmente \textit{on-line} e pode ser jogado via navegador de internet. O código fonte do jogo é disponibilizado sobre a licença MIT. O projeto é construído em Html5, JavaScript 6 e Css3. O dono e principal mantenedor do projeto é Guangcong Luo e todo código fonte do projeto pode ser encontrado no Git Hub.

O ambiente conta um grande número de jogadores simultâneos. Durante o desenvolvimento do trabalho foi verificado que muitas vezes o número de usuários simultâneos ultrapassou a quantidade de 12000.

\subsection{Regras especiais Pokémon Showdown!}

Competitivamente falando Pokémon tem uma série de problemas de balanceamento. Diferente dos jogos da franquia principal, o Pokémon Showdown! aplica algumas restrições para tornar as batalhas Pokémon ainda mais competitivas.

Como existem vários Pokémon com atributos muitos mais altos e com movimentos muito melhores que outros algumas regras foram definidas para tornar as batalhas mais justas.

O jogo Pokémon Showdown! segue as regras definida por uma comunidade de jogadores competitivos chamada Smogon \cite{smogon}, essa comunidade regula e define as regras que são utilizadas em cada modo de jogo, para que o jogo se torne mais competitivo e balanceado. Um dos principais trabalhos da Smogon é balancear os mais de 800 Pokémon distribuindo eles em faixas chamadas de \textit{tiers}. Do mais fraco para o mais forte, os principais \textit{tiers} são:

\begin{itemize}
	\item \textit{Never Used} ou NU;
	\item \textit{Rarely Used} ou RU;
	\item \textit{Under Used} ou UU;
	\item \textit{Over Used} ou OU;
	\item \textit{Ubers}.
\end{itemize}

\subsection{Modos de batalhas Pokémon Showdown!}

O jogo Pokémon Showdown! tem algumas dezenas de modos de batalhas diferentes como mostra a imagem
\ref{fig:modobatalhaspokemonshowdown}. Os modos de batalhas são altamente influenciados pelas regras da Smogon. Os modos de batalha mais utilizados são:

\begin{itemize}

	\item \textbf{Random battle} os dois jogadores são pareados com times totalmente aleatórios. Para balancear esse modo são atribuídos diferentes níveis de acordo com o \textit{tier} do Pokémon. Pokémon NU batalham no nível 86, RU 82, UU 78, OU 74 e \textit{Ubers} no nível 70.
	
	\item \textbf{OU Battle} O jogador monta seu time com Pokémon de no máximo \textit{tier} OU e são pareados com outro jogador também com time de Pokémon de \textit{tier} máximo OU. Nesse modo todos Pokémon batalham no mesmo nível.

	\item \textbf{Battle Factory} nesse modo primeiro é sorteado um \textit{tier}, cada jogador recebe um time equilibrado predefinido desse \textit{tier}. Nesse modo todos Pokémon batalham no mesmo nível. Por ser o modo de batalha onde os times dependem menos da sorte é o preferido entre os jogadores profissionais.
	
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=\columnwidth]{figures/modobatalhaspokemonshowdown.png}
\caption[Modos de batalha Pokémon Showdown!]{Modos de batalha Pokémon Showdown!.}
\label{fig:modobatalhaspokemonshowdown}
\end{figure}

\subsection{Temporizador de batalha}

Todos os modos de jogo do Pokémon Showdown! contam com um temporizador opcional, ou seja, está disponível para um dos dois jogadores pedirem para ligar o temporizador. A figura \ref{fig:showdownTimer} mostra a localização do temporizador.

\begin{figure}[H]
\centering
\includegraphics[width=12cm]{figures/showdownTimer.png}
\caption[Botão de ligar temporizador de batalha]{Botão de ligar temporizador de batalha.}
\label{fig:showdownTimer}
\end{figure}

Uma vez ligado, cada jogador recebe 150 segundos (2 minutos e meio) em seu banco de tempo para ser usado durante toda partida. A cada novo turno cada jogador recebe mais 20 segundos. O jogador que fez a escolha mais rápida também ganha 10 segundos adicionais. O tempo máximo que se pode ter no banco é de 150 segundos. A figura \ref{fig:showdownTimeLeft} mostra um indicador do tempo restante para realizar sua jogada.

\begin{figure}[H]
\centering
\includegraphics[width=12cm]{figures/showdownTimeLeft.png}
\caption[Quantidade de tempo restante para realizar a jogada]{Quantidade de tempo restante para realizar a jogada.}
\label{fig:showdownTimeLeft}
\end{figure}

\subsection{Sistema de ranqueamento Pokémon Showdown!}

O Pokémon Showdown! utiliza o sistema de ranqueamento chamado \textbf{Elo}. O sistema Elo foi criado por Arpad Elo em 1950 como uma evolução do sistema de ranqueamento utilizada pela federação de xadrez dos Estados Unidos (\cite{glickman1999rating}). Segundo \cite{coulom2007computing} O princípio da classificação de Elo é que cada jogador recebe uma estimativa de força numérica, calculada a partir da observação de resultados do jogo passado.

É muito comum associar Elo a xadrez, porém muitos jogos digitais, como Pokémon Showdown!,  e de tabuleiro, como Go, adotam esse mesmo sistema.

Elo também tem outras funções além de definir um ranqueamento para um jogador. Ele pode predizer quem tem mais chance de vencer uma partida. Pode ser usado para escolher o adversário mais apropriado para um jogo. Segundo \cite{glickman1999rating} o Elo também é utilizado para definir elegibilidade para torneios e para definição de prêmios.

A pontuação de Elo de um jogador normalmente varia entre 0 e 3000 que pode ser modificada dependendo do resultado de um campeonato (\cite{coulom2007computing}).

No Pokémon Showdown! cada jogador tem uma pontuação de Elo diferente em cada modo de jogo, o sistema de pareamento tenta buscar um adversário com semelhante pontuação de Elo. Cada jogador começa com 1000 pontos de Elo em todos os modos e, a cada partida, o Elo é atualizado. 

A equação para variação do Elo após a partida é dado por:

\begin{equation}
V = K \times \Big( score - \frac{ 1 }{ 10^{(foeElo - elo) / 400 } } \Big),
\end{equation}

onde \textbf{V} é a variação do Elo. A constante \textbf{K} regula a variação do Elo, ou seja, valores grandes para K fará com que cada partida a variação de Elo seja maior (para mais e para menos), o Pokémon Showdown utiliza o valor de K como 50. A variável \textbf{score} resultado da partida, é usado valor 0 para derrotas, 0.5 para empates e 1 para vitória. Já \textbf{foeElo} e \textbf{elo} são os valores de Elo do adversário e seu respectivamente.

Como exemplo, vamos considerar dois jogadores iniciantes chamados \textbf{A} e \textbf{B}. Ambos os jogadores tem 1000 pontos de Elo. Substituindo a equação de variação do Elo, supondo que o jogador \textbf{A} venceu, se tem:

\begin{equation}
25 = 50 \times \Big( 1 - \frac{ 1 }{ 10^{(1000 - 1000) / 400 } } \Big),
\end{equation}

onde o jogador \textbf{A} totalizaria mais 1025 pontos de Elo.

\section{API para Pokémon Showdown!}
\label{sec:apipokemonshowdown}

Umas das principais contribuições desse trabalho é a criação de duas APIs para permitir escrever agentes para jogar o Pokémon Showdown!. A primeira delas é chamada de \textit{showdownAI} e serve como uma camada para facilitar a realização de ações dentro do jogo. A segunda API é chamada de \textit{showdownSimulation} e sua função é simular em memória uma ação para poder estimar resultados, essa API é imprescindível em algoritmos que precisam prever próximas jogadas como em árvores de decisão.

Na imagem \ref{fig:APIsDiagram} mostra como um agente para Pokémon Showdown! pode trabalhar junto com as APIs, e como elas trabalham com o jogo.

\begin{figure}[H]
\centering
\includegraphics[width=\columnwidth]{figures/APIsDiagram.pdf}
\caption[APIs e Pokémon Showdown!]{APIs e Pokémon Showdown!.}
\label{fig:APIsDiagram}
\end{figure}

\subsection{showdownAI}

A API showdownAI é feita em JavaScript e entregue em formato de \textit{plugin} para o Google Chrome para facilitar a instalação. Todo o código fonte da API é escrito também e JavaScript. A figura \ref{fig:showdownAIplugin} mostra o \textit{plugin} instalado. 

\begin{figure}[H]
\centering
\includegraphics[width=12cm]{figures/showdownAIplugin.png}
\caption[showdownAI \textit{plugin}]{showdownAI \textit{plugin}.}
\label{fig:showdownAIplugin}
\end{figure}

Apesar de ser feito todo em JavaScript, a API showdownAI pode se comunicar com qualquer linguagem que tenha a tecnologia de Sockets através do recurso de WebSocket (\cite{mdn:websocket}). Com esse recurso o navegador pode se comunicar com um IP (incluindo \textit{localhost}) utilizando Socket.

\subsubsection{Métodos showdownAI}

Os métodos estão separados em três blocos: métodos utilitários, métodos para o menu inicial do jogo (\textit{lobby}) e métodos para batalhas (\textit{gameplay}). Os métodos utilitários são métodos mais relacionados a API (dados internos), os métodos para o menu do jogo permitem buscar batalhas e aceitar batalhas e os métodos de \textit{gameplay} fazem alguma ação dentro da batalha.

A figura \ref{fig:showdownAIutilityMethods} mostra os métodos classificados como de utilidade. Com mais detalhes, os principais métodos são:

\begin{itemize}

	\item \textbf{init}. Método não recebe argumentos nem retorna algum dado. Método para inicializar a API.
	
	\item \textbf{log}. Método recebe uma mensagem (String) como argumento. Esse método guarda mensagens dentro da API.

	\item \textbf{getLogs}. Método retorna um vetor de mensagens (String). Com esse método é possível pegar as mensagens da API.
	
	\item \textbf{getOpponentMessages}. Método retorna um vetor de mensagens (String). Com esse método é possível obter as mensagens do \textit{chat} do jogo. O \textit{chat} do jogo é o único meio de comunicação entre os dois jogadores.
	
	\item \textbf{pause}. Método não recebe argumentos nem retorna algum dado. Esse método faz com que a API para de ler e enviar dados para o Pokémon Shwodown!.
	
	\item \textbf{pause}. Método não recebe argumentos nem retorna algum dado. Esse método faz com que a API volte a ler e enviar dados para o Pokémon Shwodown!.
	
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=\columnwidth]{figures/showdownAIutilityMethods.png}
\caption[showdownAI métodos utilitários]{showdownAI métodos utilitários.}
\label{fig:showdownAIutilityMethods}
\end{figure}

A figura \ref{fig:showdownAILobbyMethods} mostra os métodos utilizados no menu inicial. Com mais detalhes, os principais métodos são:

\begin{itemize}

	\item \textbf{login} Método recebe como argumento nome do usuário, senha e função para ser chamada após o \textit{login} ser efetuado. Método não contém retorno.
	
	\item \textbf{searchRandomBattle}. Método recebe como argumento uma função para ser executada após achar uma partida no modo Random Battle. Método não contém retorno.
	
	\item \textbf{searchBattleFactoryBattle}. Método recebe como argumento uma função para ser executada após achar uma partida no modo Battle Factory. Método não contém retorno.
	
	\item \textbf{challengeUser}. Método recebe como argumento o nome de um usuário específico para desafiar e uma função para ser executada quando a batalha começar. Método não contém retorno.
	
	\item \textbf{waitForBattleRequest}. Método para ficar no menu inicial aceitando qualquer batalha, ele recebe como argumento uma função para ser executada quando a batalha começar. Método não contém retorno.
	
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=\columnwidth]{figures/showdownAILobbyMethods.png}
\caption[showdownAI métodos para o menu inicial]{showdownAI métodos para o menu inicial.}
\label{fig:showdownAILobbyMethods}
\end{figure}

Por fim, a figura \ref{fig:showdownAIBattleMethods1} mostra os métodos utilizados dentro da batalha. Com mais detalhes, os principais métodos são:

\begin{itemize}

	\item \textbf{getBattleSummary}. Método não recebe argumentos e retorna um texto com resumo da batalha (nome, quantidade de HP de cada Pokémon, entre outras informações suas e de seu adversário ).
	
	\item \textbf{getBattleCommands}. Método não recebe como argumentos e retorna um objeto do tipo \textit{BattleCommands}. Esse objeto pode conter 3 propriedades/objetos:
		
		\subitem \textbf{getStatus}. Método que retorna um objeto do tipo \textit{BattleStatus};
		
		\subitem \textbf{result}. Propriedade contendo o resultado da partida (valores possíveis: WIN, LOST e DRAW);
		
		\subitem \textbf{goToMainMenu}. Método que encerra o jogo atual e volta para o menu principal. O método não tem argumentos ou retorno.
	
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=\columnwidth]{figures/showdownAIBattleMethods1.png}
\caption[showdownAI métodos de batalha parte 1]{showdownAI métodos de batalha parte 1.}
\label{fig:showdownAIBattleMethods1}
\end{figure}

O objeto \textit{BattleStatus} tem mais 3 grandes objetos dentro dele como mostra a figura \ref{fig:showdownAIBattleMethods2}. Os objetos retornado por esse método são:

\begin{itemize}

	\item \textbf{actions}. Retorna um objeto com os movimentos que o Poklémon ativo pode utilizar e os Pokémons disponíveis para usar.
	
	\item \textbf{opponent}. Retorna informações do adversário como: Pokémon ativo, quantidade restante de Pokémon. Esse objeto só retorna informações conhecidas sobre o oponente.
	
	\item \textbf{activePokemon}. Retorna um objeto com informações do Pokémon ativo do jogador.
	
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=\columnwidth]{figures/showdownAIBattleMethods2.png}
\caption[showdownAI métodos de batalha parte 2]{showdownAI métodos de batalha parte 2.}
\label{fig:showdownAIBattleMethods2}
\end{figure}

O objeto \textbf{actions} tem as duas possíveis ações do turno, são elas: 

\begin{itemize}

	\item \textbf{attacks}. Retorna um vetor com apenas os golpes habilitados. Em cada objeto do vetor existem as seguintes propriedades e métodos:
		
		\subitem \textbf{name}. Propriedade que retorna o nome do golpe.
		
		\subitem \textbf{info}. Propriedade que retorna informações completas do golpe (tipo, dano, entre outros).
		
		\subitem \textbf{use}. Método para utilizar o golpe. Esse método recebe como argumento uma função que executará quando o próximo turno começar.
	
	\item \textbf{pokemons}. Retorna um vetor com apenas os Pokémon que podem entrar na luta. Em cada objeto do vetor existem as seguintes propriedades e métodos:
		
		\subitem \textbf{name}. Propriedade que o nome do Pokémon.
		
		\subitem \textbf{info}. Propriedade que retorna informações completas do Pokémon (tipo, atributos, habilidade, item, entre outros).
		
		\subitem \textbf{use}. Método para utilizar o Pokémon. Esse método recebe como argumento uma função que executará quando o próximo turno começar.
	
\end{itemize}

Por fim, o objeto \textbf{opponent} tem todas as informações sobre os Pokémon do adversário, as propriedades são

\begin{itemize}
	
	\item \textbf{activePokemon}. Retorna um objeto com todas as informações conhecidas do Pokémon ativo do adversário.
	
	\item \textbf{activePokemon}. Retorna um vetor de objeto com todas as informações conhecidas dos outros Pokémon.
	
\end{itemize}

\subsubsection{Utilizando showdownAI}

Para exemplificar a utilização da API, na figura \ref{fig:showdownAPISimples} é mostrado um agente para Random Battle que segue os seguintes passos:

\begin{itemize}
	
	\item \textbf{1}. Inicia a API (linha 27) e faz o \textit{login} com uma conta e senha (linha 28).
	
	\item \textbf{2}. Após o \textit{login} acontecer. É chamado o método de buscar batalha no modo Random Battle (linha 29).
	
	\item \textbf{3}. A cada turno se verifica se a partida não terminou (linha 2). Se a partida terminou, a partida é finalizada (linha 4), e é buscado novamente uma partida no modo Random Battle (linha 5). Caso não tenha terminado, é executado os seguintes sub-passos:
	
		\subitem \textbf{3.1}. Se não existe nenhum golpe disponível as ações possíveis são trocar de Pokémon (linha 12);
		
		\subitem \textbf{3.2}. Se não existe nenhum Pokémon disponível as ações possíveis são utilizar um golpe (linha 14);
		
		\subitem \textbf{3.3}. Caso 3.1 e 3.2 não aconteçam (linha 16), ações possíveis são aleatoriamente escolhidas entre utilizar golpes e trocar de Pokémon (linha 19).
		
		\item \textbf{3.4}. Aleatoriamente é escolhido entre as ações disponíveis (linha 23).
	
\end{itemize}

\begin{figure}[H]
\centering
\includegraphics[width=\columnwidth]{figures/showdownAPISimples.png}
\caption[Agente simples utilizando showdownAI]{Agente simples utilizando showdownAI.}
\label{fig:showdownAPISimples}
\end{figure}

\subsection{showdownSimulation}


\section{Agentes MCTS para Pokémon}
\label{sec:mctsPokemonShowdown}